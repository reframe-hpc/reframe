

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Understanding the Mechanism of Sanity Functions &mdash; ReFrame 2.9 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/banner.css" type="text/css" />
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Running ReFrame" href="running.html" />
    <link rel="prev" title="Customizing Further a Regression Test" href="advanced.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
    

          
            <a href="index.html" class="icon icon-home"> ReFrame
          

          
          </a>

          
            
            
              <div class="version">
                2.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="configure.html">Configuring ReFrame For Your Site</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">The Regression Test Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">ReFrame Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">Customizing Further A Regression Test</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Understanding The Mechanism Of Sanity Functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-is-a-deferrable-function">What Is a Deferrable Function?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deferred-expressions">Deferred expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-a-deferred-expression-is-evaluated">How a Deferred Expression Is Evaluated?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implicit-evaluation-of-a-deferred-expression">Implicit evaluation of a deferred expression</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-write-a-deferrable-function">How to Write a Deferrable Function?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deferrable-sanity-functions">Deferrable Sanity Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#similarities-and-differences-with-generators">Similarities and Differences with Generators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#similarities">Similarities</a></li>
<li class="toctree-l3"><a class="reference internal" href="#differences">Differences</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running ReFrame</a></li>
<li class="toctree-l1"><a class="reference internal" href="usecases.html">Use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About ReFrame</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="sanity_functions_reference.html">Sanity Functions Reference</a></li>
</ul>

            
          
    <hr>
    <p class="caption">
      <span class="caption-text">Useful Links</span>
    </p>
    <ul>
      <li class="toctree-l1"><a class="reference internal" href="https://github.com/eth-cscs/reframe" target="_blank">Get ReFrame</a></li>
      <li class="toctree-l1"><a class="reference internal" href="https://github.com/eth-cscs/production" target="_blank">CSCS Easybuild recipes</a></li>
      <li class="toctree-l1"><a class="reference internal" href="http://www.cscs.ch" target="_blank">CSCS</a></li>
      <li class="toctree-l1"><a class="reference internal" href="http://www.ethz.ch" target="_blank">ETH Zurich</a></li>
    </ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ReFrame</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="navigation" aria-label="breadcrumbs navigation">
  <div style="text-align: center; margin-bottom: -1.5em; display: block"></div>
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Understanding the Mechanism of Sanity Functions</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="https://github.com/eth-cscs/reframe" class="fa fa-github"> View on GitHub</a>
          
            <!-- <a href="https://eth-cscs.github.io/reframe">ReFrame</a> -->
            <!-- <a href="Section_commands.html#comm">Commands</a> -->
        
      </li>
  </ul>
  <hr/>
  
    <div class="rst-footer-buttons" style="margin-bottom: 1em" role="navigation" aria-label="footer navigation">
      
        <a href="running.html" class="btn btn-neutral float-right" title="Running ReFrame" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="advanced.html" class="btn btn-neutral" title="Customizing Further a Regression Test" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="understanding-the-mechanism-of-sanity-functions">
<h1>Understanding the Mechanism of Sanity Functions<a class="headerlink" href="#understanding-the-mechanism-of-sanity-functions" title="Permalink to this headline">¶</a></h1>
<p>This section describes the mechanism behind the sanity functions that are used for the sanity and performance checking.
Generally, writing a new sanity function is as straightforward as decorating a simple Python function with either the <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.sanity_function" title="reframe.utility.sanity.sanity_function"><code class="xref py py-func docutils literal"><span class="pre">sanity_function</span></code></a> or the <code class="xref py py-func docutils literal"><span class="pre">&#64;reframe.core.deferrable.deferrable</span></code> decorator.
However, it is important to understand how and when a deferrable function is evaluated, especially if your function takes as arguments the results of other deferrable functions.</p>
<div class="section" id="what-is-a-deferrable-function">
<h2>What Is a Deferrable Function?<a class="headerlink" href="#what-is-a-deferrable-function" title="Permalink to this headline">¶</a></h2>
<p>A deferrable function is a function whose a evaluation is deferred to a later point in time.
You can define any function as deferrable by adding the <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.sanity_function" title="reframe.utility.sanity.sanity_function"><code class="xref py py-func docutils literal"><span class="pre">&#64;sanity_funcion</span></code></a> or the <code class="xref py py-func docutils literal"><span class="pre">&#64;deferrable</span></code> decorator before its definition.
The example below demonstrates a simple scenario:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="kn">as</span> <span class="nn">sn</span>

<span class="nd">@sn.sanity_function</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you try to call <code class="docutils literal"><span class="pre">foo()</span></code>, its code will not execute:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">foo</span><span class="p">()</span>
<span class="go">&lt;reframe.core.deferrable._DeferredExpression object at 0x2b70fff23550&gt;</span>
</pre></div>
</div>
<p>Instead, a special object is returned that represents the function whose execution is deferred.
Notice the more general <em>deferred expression</em> name of this object. We shall see later on why this name is used.</p>
<p>In order to explicitly trigger the execution of <code class="docutils literal"><span class="pre">foo()</span></code>, you have to call <code class="xref py py-func docutils literal"><span class="pre">evaluate</span></code> on it:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">reframe.core.deferrable</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">foo</span><span class="p">())</span>
<span class="go">hello</span>
</pre></div>
</div>
<p>If the argument passed to <code class="xref py py-func docutils literal"><span class="pre">evaluate</span></code> is not a deferred expression, it will be simply returned as is.</p>
<p>Deferrable functions may also be combined as we do with normal functions. Let’s extend our example with <code class="docutils literal"><span class="pre">foo()</span></code> accepting an argument and printing it:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="kn">as</span> <span class="nn">sn</span>

<span class="nd">@sn.sanity_function</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

<span class="nd">@sn.sanity_function</span>
<span class="k">def</span> <span class="nf">greetings</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;hello&#39;</span>
</pre></div>
</div>
<p>If we now do <code class="docutils literal"><span class="pre">foo(greetings())</span></code>, again nothing will be evaluated:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">foo</span><span class="p">(</span><span class="n">greetings</span><span class="p">())</span>
<span class="go">&lt;reframe.core.deferrable._DeferredExpression object at 0x2b7100e9e978&gt;</span>
</pre></div>
</div>
<p>If we trigger the evaluation of <code class="docutils literal"><span class="pre">foo()</span></code> as before, we will get expected result:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">foo</span><span class="p">(</span><span class="n">greetings</span><span class="p">()))</span>
<span class="go">hello</span>
</pre></div>
</div>
<p>Notice how the evaluation mechanism goes down the function call graph and returns the expected result.
An alternative way to evaluate this expression would be the following:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">greetings</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
<span class="go">hello</span>
</pre></div>
</div>
<p>As you may have noticed, you can assign a deferred function to a variable and evaluate it later.
You may also do <code class="docutils literal"><span class="pre">evaluate(x)</span></code>, which is equivalent to <code class="docutils literal"><span class="pre">x.evaluate()</span></code>.</p>
<p>To demonstrate more clearly how the deferred evaluation of a function works, let’s consider the following <code class="docutils literal"><span class="pre">size3()</span></code> deferrable function that simply checks whether an <code class="docutils literal"><span class="pre">iterable</span></code> passed as argument has three elements inside it:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@sn.sanity_function</span>
<span class="k">def</span> <span class="nf">size3</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
</pre></div>
</div>
<p>Now let’s assume the following example:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">size3</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>We first call <code class="docutils literal"><span class="pre">size3()</span></code> and store its result in <code class="docutils literal"><span class="pre">x</span></code>.
As expected when we evaluate <code class="docutils literal"><span class="pre">x</span></code>, <code class="xref py py-class docutils literal"><span class="pre">False</span></code> is returned, since at the time of the evaluation our list has two elements.
We later append an element to our list and reevaluate <code class="docutils literal"><span class="pre">x</span></code> and we get <code class="xref py py-class docutils literal"><span class="pre">True</span></code>, since at this point the list has three elements.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Deferred functions and expressions may be stored and (re)evaluated at any later point in the program.</p>
</div>
<p>An important thing to point out here is that deferrable functions <em>capture</em> their arguments at the point they are called.
If you change the binding of a variable name (either explicitly or implicitly by applying an operator to an immutable object), this change will not be reflected when you evaluate the deferred function.
The function instead will operate on its captured arguments.
We will demonstrate this by replacing the list in the above example with a tuple:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">size3</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span>
<span class="go">(1, 2, 3)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">False</span>
</pre></div>
</div>
<p>Why this is happening?
This is because tuples are immutable so when we are doing <code class="docutils literal"><span class="pre">l</span> <span class="pre">+=</span> <span class="pre">(3,)</span></code> to append to our tuple, Python constructs a new tuple and rebinds <code class="docutils literal"><span class="pre">l</span></code> to the newly created tuple that has three elements.
However, when we called our deferrable function, <code class="docutils literal"><span class="pre">l</span></code> was pointing to a different tuple object, and that was the actual tuple argument that our deferrable function has captured.</p>
<p>The following augmented example demonstrates this:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">size3</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span>
<span class="go">(1, 2, 3)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">id</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="go">47764346657160</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">size3</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">id</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="go">47764330582232</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span>
<span class="go">(1, 2, 3)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">False</span>
</pre></div>
</div>
<p>Notice the different IDs of <code class="docutils literal"><span class="pre">l</span></code> before and after the <code class="docutils literal"><span class="pre">+=</span></code> operation.
This a key trait of deferrable functions and expressions that you should be aware of.</p>
</div>
<div class="section" id="deferred-expressions">
<h2>Deferred expressions<a class="headerlink" href="#deferred-expressions" title="Permalink to this headline">¶</a></h2>
<p>You might be still wondering why the internal name of a deferred function refers to the more general term deferred expression.
Here is why:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@sn.sanity_function</span>
<span class="gp">... </span><span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span>
<span class="go">&lt;reframe.core.deferrable._DeferredExpression object at 0x2b1288f4e940&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">10</span>
</pre></div>
</div>
<p>As you can see, you can use the result of a deferred function inside arithmetic operations.
The result will be another deferred expression that you can evaluate later.
You can practically use any Python builtin operator or builtin function with a deferred expression and the result will be another deferred expression.
This is quite a powerful mechanism, since with the standard syntax you can create arbitrary expressions that may be evaluated later in your program.</p>
<p>There are some exceptions to this rule, though.
The logical <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#and" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">and</span></code></a>, <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#or" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">or</span></code></a> and <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#not" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">not</span></code></a> operators as well as the <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#in" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">in</span></code></a> operator cannot be deferred automatically.
These operators try to take the truthy value of their arguments by calling <code class="xref py py-func docutils literal"><span class="pre">bool</span></code> on them.
As we shall see later, applying the <code class="xref py py-func docutils literal"><span class="pre">bool</span></code> function on a deferred expression causes its immediate evaluation and returns the result.
If you want to defer the execution of such operators, you should use the corresponding <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.and_" title="reframe.utility.sanity.and_"><code class="xref py py-func docutils literal"><span class="pre">and_</span></code></a>, <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.or_" title="reframe.utility.sanity.or_"><code class="xref py py-func docutils literal"><span class="pre">or_</span></code></a>, <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.not_" title="reframe.utility.sanity.not_"><code class="xref py py-func docutils literal"><span class="pre">not_</span></code></a> and <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.contains" title="reframe.utility.sanity.contains"><code class="xref py py-func docutils literal"><span class="pre">contains</span></code></a> functions in <a class="reference internal" href="sanity_functions_reference.html#module-reframe.utility.sanity" title="reframe.utility.sanity"><code class="xref py py-mod docutils literal"><span class="pre">reframe.utility.sanity</span></code></a>, which basically wrap the expression in a deferrable function.</p>
<p>In summary deferrable functions have the following characteristics:</p>
<ul class="simple">
<li>You can make any function deferrable by preceding it with the <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.sanity_function" title="reframe.utility.sanity.sanity_function"><code class="xref py py-func docutils literal"><span class="pre">&#64;sanity_function</span></code></a> or the <code class="xref py py-func docutils literal"><span class="pre">&#64;deferrable</span></code> decorator.</li>
<li>When you call a deferrable function, its body is not executed but its arguments are <em>captured</em> and an object representing the deferred function is returned.</li>
<li>You can execute the body of a deferrable function at any later point by calling <code class="xref py py-func docutils literal"><span class="pre">evaluate</span></code> on the deferred expression object that it has been returned by the call to the deferred function.</li>
<li>Deferred functions can accept other deferred expressions as arguments and may also return a deferred expression.</li>
<li>When you evaluate a deferrable function, any other deferrable function down the call tree will also be evaluated.</li>
<li>You can include a call to a deferrable function in any Python expression and the result will be another deferred expression.</li>
</ul>
</div>
<div class="section" id="how-a-deferred-expression-is-evaluated">
<h2>How a Deferred Expression Is Evaluated?<a class="headerlink" href="#how-a-deferred-expression-is-evaluated" title="Permalink to this headline">¶</a></h2>
<p>As discussed before, you can create a new deferred expression by calling a function whose definition is decorated by the <code class="docutils literal"><span class="pre">&#64;sanity_function</span></code> or <code class="docutils literal"><span class="pre">&#64;deferrable</span></code> decorator or by including an already deferred expression in any sort of arithmetic operation.
When you call <code class="xref py py-func docutils literal"><span class="pre">evaluate</span></code> on a deferred expression, you trigger the evaluation of the whole subexpression tree.
Here is how the evaluation process evolves:</p>
<p>A deferred expression object is merely a placeholder of the target function and its arguments at the moment you call it.
Deferred expressions leverage also the Python’s data model so as to capture all the binary and unary operators supported by the language.
When you call <code class="docutils literal"><span class="pre">evaluate()</span></code> on a deferred expression object, the stored function will be called passing it the captured arguments.
If any of the arguments is a deferred expression, it will be evaluated too.
If the return value of the deferred expression is also a deferred expression, it will be evaluated as well.</p>
<p>This last property lets you call other deferrable functions from inside a deferrable function.
Here is an example where we define two deferrable variations of the builtins <code class="xref py py-func docutils literal"><span class="pre">sum</span></code> and <a class="reference external" href="https://docs.python.org/3/library/functions.html#len" title="(in Python v3.7)"><code class="xref py py-func docutils literal"><span class="pre">len</span></code></a> and another deferrable function <code class="docutils literal"><span class="pre">avg()</span></code> that computes the average value of the elements of an iterable by calling our deferred builtin alternatives.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@sn.sanity_function</span>
<span class="k">def</span> <span class="nf">dsum</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>

<span class="nd">@sn.sanity_function</span>
<span class="k">def</span> <span class="nf">dlen</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>

<span class="nd">@sn.sanity_function</span>
<span class="k">def</span> <span class="nf">avg</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dsum</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="o">/</span> <span class="n">dlen</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
</pre></div>
</div>
<p>If you try to evaluate <code class="docutils literal"><span class="pre">avg()</span></code> with a list, you will get the expected result:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">avg</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="go">&lt;reframe.core.deferrable._DeferredExpression object at 0x2b1288f54b70&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">avg</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
<span class="go">2.5</span>
</pre></div>
</div>
<p>The return value of <code class="docutils literal"><span class="pre">evaluate(avg())</span></code> would normally be a deferred expression representing the division of the results of the other two deferrable functions.
However, the evaluation mechanism detects that the return value is a deferred expression and it automatically triggers its evaluation, yielding the expected result.
The following figure shows how the evaluation evolves for this particular example:</p>
<div class="figure align-center" id="id1">
<img alt="Sequence diagram of the evaluation of the deferrable ``avg()`` function." src="_images/deferrable-evaluation.svg" /><p class="caption"><span class="caption-text">Sequence diagram of the evaluation of the deferrable <code class="docutils literal"><span class="pre">avg()</span></code> function.</span></p>
</div>
</div>
<div class="section" id="implicit-evaluation-of-a-deferred-expression">
<h2>Implicit evaluation of a deferred expression<a class="headerlink" href="#implicit-evaluation-of-a-deferred-expression" title="Permalink to this headline">¶</a></h2>
<p>Although you can trigger the evaluation of a deferred expression at any time by calling <code class="xref py py-func docutils literal"><span class="pre">evaluate</span></code>, there are some cases where the evaluation is triggered implicitly:</p>
<ul>
<li><p class="first">When you try to get the truthy value of a deferred expression by calling <code class="xref py py-func docutils literal"><span class="pre">bool</span></code> on it.
This happens for example when you include a deferred expression in an <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#if" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">if</span></code></a> statement or as an argument to the <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#and" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">and</span></code></a>, <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#or" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">or</span></code></a>, <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#not" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">not</span></code></a> and <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#in" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">in</span></code></a> (<code class="xref py py-func docutils literal"><span class="pre">__contains__</span></code>) operators.
The following example demonstrates this behavior:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">avg</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">hello</span>
</pre></div>
</div>
<p>The expression <code class="docutils literal"><span class="pre">avg([1,</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">4])</span> <span class="pre">&gt;</span> <span class="pre">2</span></code> is a deferred expression, but its evaluation is triggered from the Python interpreter by calling the <code class="docutils literal"><span class="pre">bool()</span></code> method on it, in order to evaluate the <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#if" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">if</span></code></a> statement.
A similar example is the following that demonstrates the behaviour of the <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#in" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">in</span></code></a> operator:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">reframe.core.deferrable</span> <span class="kn">import</span> <span class="n">make_deferrable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="n">make_deferrable</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span>
<span class="go">&lt;reframe.core.deferrable._DeferredExpression object at 0x2b1288f54cf8&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="go">[1, 2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">4</span> <span class="ow">in</span> <span class="n">l</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">3</span> <span class="ow">in</span> <span class="n">l</span>
<span class="go">True</span>
</pre></div>
</div>
<p>The <code class="xref py py-func docutils literal"><span class="pre">make_deferrable</span></code> is simply a deferrable version of the identity function (a function that simply returns its argument).
As expected, <code class="docutils literal"><span class="pre">l</span></code> is a deferred expression that evaluates to the <code class="docutils literal"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code> list. When we apply the <a class="reference external" href="https://docs.python.org/3/reference/expressions.html#in" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">in</span></code></a> operator, the deferred expression is immediately evaluated.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Python expands this expression into <code class="docutils literal"><span class="pre">bool(l.__contains__(3))</span></code>.
Although <code class="xref py py-func docutils literal"><span class="pre">__contains__</span></code> is also defined as a deferrable function in <code class="xref py py-class docutils literal"><span class="pre">_DeferredExpression</span></code>, its evaluation is triggered by the <code class="xref py py-func docutils literal"><span class="pre">bool</span></code> builtin.</p>
</div>
</li>
<li><p class="first">When you try to iterate over a deferred expression by calling the <a class="reference external" href="https://docs.python.org/3/library/functions.html#iter" title="(in Python v3.7)"><code class="xref py py-func docutils literal"><span class="pre">iter</span></code></a> function on it.
This call happens implicitly by the Python interpreter when you try to iterate over a container.
Here is an example:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@sn.sanity_function</span>
<span class="gp">... </span><span class="k">def</span> <span class="nf">getlist</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">ret</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">ret</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">ret</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">getlist</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="go">&lt;reframe.core.deferrable._DeferredExpression object at 0x2b1288f54dd8&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">getlist</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
</pre></div>
</div>
<p>Simply calling <code class="docutils literal"><span class="pre">getlist()</span></code> will not execute anything and a deferred expression object will be returned.
However, when you try to iterate over the result of this call, then the deferred expression will be evaluated immediately.</p>
</li>
<li><p class="first">When you try to call <code class="xref py py-func docutils literal"><span class="pre">str</span></code> on a deferred expression.
This will be called by the Python interpreter every time you try to print this expression.
Here is an example with the <code class="docutils literal"><span class="pre">getlist</span></code> deferrable function:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">getlist</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>
<span class="go">[1, 2, 3, 1, 2, 3]</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="how-to-write-a-deferrable-function">
<h2>How to Write a Deferrable Function?<a class="headerlink" href="#how-to-write-a-deferrable-function" title="Permalink to this headline">¶</a></h2>
<p>The answer is simple:
like you would with any other normal function!
We’ve done that already in all the examples we’ve shown in this documentation.
A question that somehow naturally comes up here is whether you can call a deferrable function from within a deferrable function, since this doesn’t make a lot of sense:
after all, your function will be deferred anyway.</p>
<p>The answer is, yes.
You can call other deferrable functions from within a deferrable function.
Thanks to the implicit evaluation rules as well as the fact that the return value of a deferrable function is also evaluated if it is a deferred expression, you can write a deferrable function without caring much about whether the functions you call are themselves deferrable or not.
However, you should be aware of passing mutable objects to deferrable functions.
If these objects happen to change between the actual call and the implicit evaluation of the deferrable function, you might run into surprises.
In any case, if you want the immediate evaluation of a deferrable function or expression, you can always do that by calling <code class="xref py py-func docutils literal"><span class="pre">evaluate</span></code> on it.</p>
<p>The following example demonstrates two different ways writing a deferrable function that checks the average of the elements of an iterable:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="kn">as</span> <span class="nn">sn</span>

<span class="nd">@sn.sanity_function</span>
<span class="k">def</span> <span class="nf">check_avg_with_deferrables</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="o">/</span> <span class="n">sn</span><span class="o">.</span><span class="n">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">avg</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span>

<span class="nd">@sn.sanity_function</span>
<span class="k">def</span> <span class="nf">check_avg_without_deferrables</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">avg</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">check_avg_with_deferrables</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
<span class="go">-1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">evaluate</span><span class="p">(</span><span class="n">check_avg_without_deferrables</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
<span class="go">-1</span>
</pre></div>
</div>
<p>The first version uses the <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.sum" title="reframe.utility.sanity.sum"><code class="xref py py-func docutils literal"><span class="pre">sum</span></code></a> and <a class="reference internal" href="sanity_functions_reference.html#reframe.utility.sanity.len" title="reframe.utility.sanity.len"><code class="xref py py-func docutils literal"><span class="pre">len</span></code></a> functions from <a class="reference internal" href="sanity_functions_reference.html#module-reframe.utility.sanity" title="reframe.utility.sanity"><code class="xref py py-mod docutils literal"><span class="pre">reframe.utility.sanity</span></code></a>, which are deferrable versions of the corresponding builtins.
The second version uses directly the builtin <a class="reference external" href="https://docs.python.org/3/library/functions.html#sum" title="(in Python v3.7)"><code class="xref py py-func docutils literal"><span class="pre">sum</span></code></a> and <a class="reference external" href="https://docs.python.org/3/library/functions.html#len" title="(in Python v3.7)"><code class="xref py py-func docutils literal"><span class="pre">len</span></code></a> functions.
As you can see, both of them behave in exactly the same way.
In the version with the deferrables, <code class="docutils literal"><span class="pre">avg</span></code> is a deferred expression but it is evaluated by the <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#if" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">if</span></code></a> statement before returning.</p>
<p>Generally, inside a sanity function, it is a preferable to use the non-deferrable version of a function, if that exists, since you avoid the extra overhead and bookkeeping of the deferring mechanism.</p>
</div>
<div class="section" id="deferrable-sanity-functions">
<h2>Deferrable Sanity Functions<a class="headerlink" href="#deferrable-sanity-functions" title="Permalink to this headline">¶</a></h2>
<p>Normally, you will not have to implement your own sanity functions, since ReFrame provides already a variety of them.
You can find the complete list of provided sanity functions <a class="reference external" href="sanity_functions_reference.html">here</a>.</p>
<div class="section" id="similarities-and-differences-with-generators">
<h3>Similarities and Differences with Generators<a class="headerlink" href="#similarities-and-differences-with-generators" title="Permalink to this headline">¶</a></h3>
<p>Python allows you to create functions that will be evaluated lazily.
These are called <a class="reference external" href="https://wiki.python.org/moin/Generators">generator functions</a>.
Their key characteristic is that instead of using the <a class="reference external" href="https://docs.python.org/3/reference/simple_stmts.html#return" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">return</span></code></a> keyword to return values, they use the <a class="reference external" href="https://docs.python.org/3/reference/simple_stmts.html#yield" title="(in Python v3.7)"><code class="xref std std-keyword docutils literal"><span class="pre">yield</span></code></a> keyword.
I’m not going to go into the details of the generators, since there is plenty of documentation out there, so I will focus on the similarities and differences with our deferrable functions.</p>
</div>
<div class="section" id="similarities">
<h3>Similarities<a class="headerlink" href="#similarities" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Both generators and our deferrables return an object representing the deferred expression when you call them.</li>
<li>Both generators and deferrables may be evaluated explicitly or implicitly when they appear in certain expressions.</li>
<li>When you try to iterate over a generator or a deferrable, you trigger its evaluation.</li>
</ul>
</div>
<div class="section" id="differences">
<h3>Differences<a class="headerlink" href="#differences" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">You can include deferrables in any arithmetic expression and the result will be another deferrable expression.
This is not true with generator functions, which will raise a <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#TypeError" title="(in Python v3.7)"><code class="xref py py-class docutils literal"><span class="pre">TypeError</span></code></a> in such cases or they will always evaluate to <code class="xref py py-class docutils literal"><span class="pre">False</span></code> if you include them in boolean expressions
Here is an example demonstrating this:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@sn.sanity_function</span>
<span class="gp">... </span><span class="k">def</span> <span class="nf">dsize</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">))</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">gsize</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">))</span>
<span class="gp">... </span>    <span class="k">yield</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dsize</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="go">&lt;reframe.core.deferrable._DeferredExpression object at 0x2abc630abb38&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gsize</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="go">&lt;generator object gsize at 0x2abc62a4bf10&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span> <span class="o">=</span> <span class="n">gsize</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span> <span class="o">=</span> <span class="n">gsize</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">TypeError</span>: <span class="n">unsupported operand type(s) for +: &#39;generator&#39; and &#39;int&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span> <span class="o">=</span> <span class="n">dsize</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span>
<span class="go">&lt;reframe.core.deferrable._DeferredExpression object at 0x2abc630abba8&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span> <span class="o">=</span> <span class="n">dsize</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expr</span>
<span class="go">&lt;reframe.core.deferrable._DeferredExpression object at 0x2abc630abc18&gt;</span>
</pre></div>
</div>
</li>
</ul>
<p>Notice that you cannot include generators in expressions, whereas you can generate arbitrary expressions with deferrables.</p>
<ul>
<li><p class="first">Generators are iterator objects, while deferred expressions are not.
As a result, you can trigger the evaluation of a generator expression using the <a class="reference external" href="https://docs.python.org/3/library/functions.html#next" title="(in Python v3.7)"><code class="xref py py-func docutils literal"><span class="pre">next</span></code></a> builtin function.
For a deferred expression you should use <code class="xref py py-func docutils literal"><span class="pre">evaluate</span></code> instead.</p>
</li>
<li><p class="first">A generator object is iterable, whereas a deferrable object will be iterable if and only if the result of its evaluation is iterable.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Technically, a deferrable object is iterable, too, since it provides the <code class="xref py py-func docutils literal"><span class="pre">__iter__</span></code> method.
That’s why you can include it in iteration expressions. However, it delegates this call to the result of its evaluation.</p>
</div>
<p>Here is an example demonstrating this difference:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gsize</span><span class="p">(</span><span class="n">l</span><span class="p">):</span> <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">2</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dsize</span><span class="p">(</span><span class="n">l</span><span class="p">):</span> <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">2</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">&quot;/users/karakasv/Devel/reframe/reframe/core/deferrable.py&quot;</span>, line <span class="m">73</span>, in <span class="n">__iter__</span>
    <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">())</span>
<span class="gr">TypeError</span>: <span class="n">&#39;int&#39; object is not iterable</span>
</pre></div>
</div>
<p>Notice how the iteration works fine with the generator object, whereas with the deferrable function, the iteration call is delegated to the result of the evaluation, which is not an iterable, therefore yielding <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#TypeError" title="(in Python v3.7)"><code class="xref py py-class docutils literal"><span class="pre">TypeError</span></code></a>.
Notice also, the printout of <code class="docutils literal"><span class="pre">2</span></code> in the iteration over the deferrable expression, which shows that it has been evaluated.</p>
</li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          
<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="running.html" class="btn btn-neutral float-right" title="Running ReFrame" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="advanced.html" class="btn btn-neutral" title="Customizing Further a Regression Test" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, CSCS.
    </p>

    <style type="text/css">
      .cscs_group:after {
        content:"";
        display: table;
        clear: both;
      }
      .cscs_left {
        float: left;
        width: 50%;
      }
      .cscs_right {
        float: right;
        width: 50%;
    }
      @media screen and (max-width: 768px) {
        .cscs_left,
        .cscs_right {
          float: none;
          width: auto;
          margin-bottom: 20px;
        }
      }
    </style>
    <p>
      <div class="cscs_group">
        <div class="cscs_left">
          <strong>CSCS</strong><br />
          <strong>Swiss National Supercomputing Centre</strong><br />
          Via Trevano 131<br />
          6900 Lugano<br />
          Switzerland
        </div>
        <div  class="cscs_right" style="margin-left: auto; margin-right: auto;">
          <a href="http://www.cscs.ch" target="_blank">
            <img id="cscs-cscs-logo" src="_static/img/logo_cscs.png" style="background-color: transparent; margin-top: 5px;">
          </a>
        </div>
      </div>
    </p>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

  </div>

</footer>
        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: v2.9
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../v2.10/deferrables.html">v2.10</a></dd>
            <dd><a href="../v2.11/deferrables.html">v2.11</a></dd>
            <dd><a href="../v2.12/deferrables.html">v2.12</a></dd>
            <dd><a href="../v2.13/deferrables.html">v2.13</a></dd>
            <dd><a href="../v2.14/deferrables.html">v2.14</a></dd>
            <dd><a href="../v2.15/deferrables.html">v2.15</a></dd>
            <dd><a href="../v2.7/deferrables.html">v2.7</a></dd>
            <dd><a href="../v2.8/deferrables.html">v2.8</a></dd>
            <dd><a href="deferrables.html">v2.9</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../master/deferrables.html">master</a></dd>
        </dl>
    </div>
</div>


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'2.9',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>