

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Customizing Further a Regression Test &mdash; ReFrame 2.8 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/banner.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="about.html"/>
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="ReFrame 2.8 documentation" href="index.html"/>
        <link rel="next" title="Understanding the Mechanism of Sanity Functions" href="deferrables.html"/>
        <link rel="prev" title="ReFrame Tutorial" href="tutorial.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
    

          
            <a href="index.html" class="icon icon-home"> ReFrame
          

          
          </a>

          
            
            
              <div class="version">
                2.8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="configure.html">Configuring ReFrame For Your Site</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">The Regression Test Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">ReFrame Tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Customizing Further A Regression Test</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#leveraging-makefiles">Leveraging Makefiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementing-a-run-only-regression-test">Implementing a Run-Only Regression Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementing-a-compile-only-regression-test">Implementing a Compile-Only Regression Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#leveraging-environment-variables">Leveraging Environment Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-a-time-limit-for-regression-tests">Setting a Time Limit for Regression Tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deferrables.html">Understanding The Mechanism Of Sanity Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running ReFrame</a></li>
<li class="toctree-l1"><a class="reference internal" href="usecases.html">Use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About ReFrame</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="sanity_functions_reference.html">Sanity Functions Reference</a></li>
</ul>

            
          
    <hr>
    <p class="caption">
      <span class="caption-text">Useful Links</span>
    </p>
    <ul>
      <li class="toctree-l1"><a class="reference internal" href="https://github.com/eth-cscs/reframe" target="_blank">Get ReFrame</a></li>
      <li class="toctree-l1"><a class="reference internal" href="https://github.com/eth-cscs/production" target="_blank">CSCS Easybuild recipes</a></li>
      <li class="toctree-l1"><a class="reference internal" href="http://www.cscs.ch" target="_blank">CSCS</a></li>
      <li class="toctree-l1"><a class="reference internal" href="http://www.ethz.ch" target="_blank">ETH Zurich</a></li>
    </ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ReFrame</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <div style="text-align: center; margin-bottom: -1.5em; display: block">ReFrame 2.8</div>
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Customizing Further a Regression Test</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="https://github.com/eth-cscs/reframe" class="fa fa-github"> View on GitHub</a>
          
            <!-- <a href="https://eth-cscs.github.io/reframe">ReFrame</a> -->
            <!-- <a href="Section_commands.html#comm">Commands</a> -->
        
      </li>
  </ul>
  <hr/>
  
    <div class="rst-footer-buttons" style="margin-bottom: 1em" role="navigation" aria-label="footer navigation">
      
        <a href="deferrables.html" class="btn btn-neutral float-right" title="Understanding the Mechanism of Sanity Functions" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial.html" class="btn btn-neutral" title="ReFrame Tutorial" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="customizing-further-a-regression-test">
<span id="customizing-further-a-regression-test"></span><h1>Customizing Further a Regression Test<a class="headerlink" href="#customizing-further-a-regression-test" title="Permalink to this headline">¶</a></h1>
<p>In this section, we are going to show some more elaborate use cases of ReFrame.
Through the use of more advanced examples, we will demonstrate further customization options which modify the default options of the ReFrame pipeline.
The corresponding scripts as well as the source code of the examples discussed here can be found in the directory <code class="docutils literal"><span class="pre">tutorial/advanced</span></code>.</p>
<div class="section" id="leveraging-makefiles">
<span id="leveraging-makefiles"></span><h2>Leveraging Makefiles<a class="headerlink" href="#leveraging-makefiles" title="Permalink to this headline">¶</a></h2>
<p>We have already shown how you can compile a single source file associated with your regression test.
In this example, we show how ReFrame can leverage Makefiles to build executables.</p>
<p>Compiling a regression test through a Makefile is very straightforward with ReFrame.
If the <code class="docutils literal"><span class="pre">sourcepath</span></code> attribute refers to a directory, then ReFrame will automatically invoke <code class="docutils literal"><span class="pre">make</span></code> there.</p>
<blockquote>
<div>NOTE: More specifically, ReFrame constructs the final target source path as <code class="docutils literal"><span class="pre">os.path.join(self.sourcesdir,</span> <span class="pre">self.sourcepath)</span></code></div></blockquote>
<p>By default, <code class="docutils literal"><span class="pre">sourcepath</span></code> is the empty string and <code class="docutils literal"><span class="pre">sourcesdir</span></code> is set <code class="docutils literal"><span class="pre">src/</span></code>.
As a result, by not specifying a <code class="docutils literal"><span class="pre">sourcepath</span></code> at all, ReFrame will try to invoke <code class="docutils literal"><span class="pre">make</span></code> inside the <code class="docutils literal"><span class="pre">src/</span></code> directory of the test.
This is exactly what our first example here does.</p>
<p>For completeness, here are the contents of <code class="docutils literal"><span class="pre">Makefile</span></code> provided:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>EXECUTABLE := advanced_example1

OBJS := advanced_example1.o

$(EXECUTABLE): $(OBJS)
    $(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^

$(OBJS): advanced_example1.c
    $(CC) $(CPPFLAGS) $(CFLAGS) -c $(LDFLAGS) -o $@ $^
</pre></div>
</div>
<p>The corresponding <code class="docutils literal"><span class="pre">advanced_example1.c</span></code> source file consists of a simple printing of a message, whose content depends on the preprocessor variable <code class="docutils literal"><span class="pre">MESSAGE</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(){</span>
<span class="c1">#ifdef MESSAGE</span>
    <span class="n">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;SUCCESS&quot;</span><span class="p">;</span>
<span class="c1">#else</span>
    <span class="n">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;FAILURE&quot;</span><span class="p">;</span>
<span class="c1">#endif</span>
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Setting of preprocessor variable: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The purpose of the regression test in this case is to set the preprocessor variable <code class="docutils literal"><span class="pre">MESSAGE</span></code> via <code class="docutils literal"><span class="pre">CPPFLAGS</span></code> and then check the standard output for the message <code class="docutils literal"><span class="pre">SUCCESS</span></code>, which indicates that the preprocessor flag has been passed and processed correctly by the Makefile.</p>
<p>The contents of this regression test are the following (<code class="docutils literal"><span class="pre">tutorial/advanced/advanced_example1.py</span></code>):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="kn">as</span> <span class="nn">sn</span>
<span class="kn">from</span> <span class="nn">reframe.core.pipeline</span> <span class="kn">import</span> <span class="n">RegressionTest</span>


<span class="k">class</span> <span class="nc">MakefileTest</span><span class="p">(</span><span class="n">RegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;preprocessor_check&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the use of Makefiles &#39;</span>
                      <span class="s1">&#39;and compile options&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;./advanced_example1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span><span class="s1">&#39;SUCCESS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_environ</span><span class="o">.</span><span class="n">cppflags</span> <span class="o">=</span> <span class="s1">&#39;-DMESSAGE&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_get_checks</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">MakefileTest</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
</pre></div>
</div>
<p>The important bit here is the <code class="docutils literal"><span class="pre">compile()</span></code> method.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_environ</span><span class="o">.</span><span class="n">cppflags</span> <span class="o">=</span> <span class="s1">&#39;-DMESSAGE&#39;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</pre></div>
</div>
<p>As in the simple single source file examples we showed in the <a class="reference external" href="tutorial.html">tutorial</a>, we use the current programming environment's flags for modifying the compilation.
ReFrame will then compile the regression test source code as by invoking <code class="docutils literal"><span class="pre">make</span></code> as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">CC</span><span class="o">=</span><span class="n">cc</span> <span class="n">CXX</span><span class="o">=</span><span class="n">CC</span> <span class="n">FC</span><span class="o">=</span><span class="n">ftn</span> <span class="n">CPPFLAGS</span><span class="o">=-</span><span class="n">DMESSAGE</span>
</pre></div>
</div>
<p>Notice, how ReFrame passes all the programming environment's variables to the <code class="docutils literal"><span class="pre">make</span></code> invocation.
It is important to note here that, if a set of flags is set to <code class="docutils literal"><span class="pre">None</span></code> (the default, if not otherwise set in the <a class="reference external" href="configure.html#environments-configuration">ReFrame's configuration</a>), these are not passed to <code class="docutils literal"><span class="pre">make</span></code>.
You can also completely disable the propagation of any flags to <code class="docutils literal"><span class="pre">make</span></code> by setting <code class="docutils literal"><span class="pre">self.propagate</span> <span class="pre">=</span> <span class="pre">False</span></code> in your regression test.</p>
<p>At this point it is useful also to note that you can also use a custom Makefile, not named <code class="docutils literal"><span class="pre">Makefile</span></code> or after any other standard Makefile name.
In this case, you can pass the custom Makefile name as an argument to the compile method of the base <code class="docutils literal"><span class="pre">RegressionTest</span></code> class as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">makefile</span><span class="o">=</span><span class="s1">&#39;Makefile_custom&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="implementing-a-run-only-regression-test">
<span id="implementing-a-run-only-regression-test"></span><h2>Implementing a Run-Only Regression Test<a class="headerlink" href="#implementing-a-run-only-regression-test" title="Permalink to this headline">¶</a></h2>
<p>There are cases when it is desirable to perform regression testing for an already built executable.
The following test uses the <code class="docutils literal"><span class="pre">echo</span></code> Bash shell command to print a random integer between specific lower and upper bounds.
Here is the full regression test (<code class="docutils literal"><span class="pre">tutorial/advanced/advanced_example2.py</span></code>):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="kn">as</span> <span class="nn">sn</span>
<span class="kn">from</span> <span class="nn">reframe.core.pipeline</span> <span class="kn">import</span> <span class="n">RunOnlyRegressionTest</span>


<span class="k">class</span> <span class="nc">RunOnlyTest</span><span class="p">(</span><span class="n">RunOnlyRegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;run_only_check&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the class&#39;</span>
                      <span class="s1">&#39;RunOnlyRegressionTest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="mi">90</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;echo $((RANDOM%({1}+1-{0})+{0}))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_bounded</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">extractsingle</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;(?P&lt;number&gt;\S+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">_get_checks</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">RunOnlyTest</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
</pre></div>
</div>
<p>There is nothing special for this test compared to those presented <a class="reference external" href="tutorial.html">earlier</a> except that it derives from the <code class="docutils literal"><span class="pre">RunOnlyRegressionTest</span></code>.
A thing to note about run-only regression tests is that the copying of their resources to the stage directory is performed at the beginning of the run phase.
For standard regression tests, this happens at the beginning of the compilation phase, instead.</p>
</div>
<div class="section" id="implementing-a-compile-only-regression-test">
<span id="implementing-a-compile-only-regression-test"></span><h2>Implementing a Compile-Only Regression Test<a class="headerlink" href="#implementing-a-compile-only-regression-test" title="Permalink to this headline">¶</a></h2>
<p>ReFrame provides the option to write compile-only tests which consist only of a compilation phase without a specified executable.
This kind of tests must derive from the <code class="docutils literal"><span class="pre">CompileOnlyRegressionTest</span></code> class provided by the framework.
The following example (<code class="docutils literal"><span class="pre">tutorial/advanced/advanced_example3.py</span></code>) reuses the code of our first example in this section and checks that no warnings are issued by the compiler:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="kn">as</span> <span class="nn">sn</span>
<span class="kn">from</span> <span class="nn">reframe.core.pipeline</span> <span class="kn">import</span> <span class="n">CompileOnlyRegressionTest</span>


<span class="k">class</span> <span class="nc">CompileOnlyTest</span><span class="p">(</span><span class="n">CompileOnlyRegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;compile_only_check&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the class&#39;</span>
                      <span class="s1">&#39;CompileOnlyRegressionTest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_not_found</span><span class="p">(</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">_get_checks</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">CompileOnlyTest</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
</pre></div>
</div>
<p>The important thing to note here is that the standard output and standard error of the tests, accessible through the <code class="docutils literal"><span class="pre">stdout</span></code> and <code class="docutils literal"><span class="pre">stderr</span></code> attributes, are now the corresponding those of the compilation command.
So sanity checking can be done in exactly the same way as with a normal test.</p>
</div>
<div class="section" id="leveraging-environment-variables">
<span id="leveraging-environment-variables"></span><h2>Leveraging Environment Variables<a class="headerlink" href="#leveraging-environment-variables" title="Permalink to this headline">¶</a></h2>
<p>We have already demonstrated in the <a class="reference external" href="tutorial.html">tutorial</a> that ReFrame allows you to load the required modules for regression tests and also set any needed environment variables.
When setting environment variables for your test through the <code class="docutils literal"><span class="pre">variables</span></code> attribute, you can assign them values of other, already defined, environment variables using the standard notation <code class="docutils literal"><span class="pre">$OTHER_VARIABLE</span></code> or <code class="docutils literal"><span class="pre">${OTHER_VARIABLE}</span></code>.
The following regression test (<code class="docutils literal"><span class="pre">tutorial/advanced/advanced_example4.py</span></code>) sets the <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> environment variable to the value of the <code class="docutils literal"><span class="pre">CUDATOOLKIT_HOME</span></code> and then compiles and runs a simple program:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="kn">as</span> <span class="nn">sn</span>
<span class="kn">from</span> <span class="nn">reframe.core.pipeline</span> <span class="kn">import</span> <span class="n">RegressionTest</span>


<span class="k">class</span> <span class="nc">EnvironmentVariableTest</span><span class="p">(</span><span class="n">RegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;env_variable_check&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the use&#39;</span>
                      <span class="s1">&#39;of environment variables provided by loaded modules&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;daint:gpu&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cudatoolkit&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CUDA_HOME&#39;</span><span class="p">:</span> <span class="s1">&#39;$CUDATOOLKIT_HOME&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;./advanced_example4&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;SUCCESS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">makefile</span><span class="o">=</span><span class="s1">&#39;Makefile_example4&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_checks</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">EnvironmentVariableTest</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
</pre></div>
</div>
<p>Before discussing this test in more detail, let's first have a look in the source code and the Makefile of this example:</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="cp">#ifndef CUDA_HOME</span>
<span class="cp">#   define CUDA_HOME &quot;&quot;</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cuda_home_compile</span> <span class="o">=</span> <span class="n">CUDA_HOME</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cuda_home_runtime</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;CUDA_HOME&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cuda_home_runtime</span> <span class="o">&amp;&amp;</span>
        <span class="n">strnlen</span><span class="p">(</span><span class="n">cuda_home_runtime</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">strnlen</span><span class="p">(</span><span class="n">cuda_home_compile</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cuda_home_compile</span><span class="p">,</span> <span class="n">cuda_home_runtime</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;FAILURE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Compiled with CUDA_HOME=%s, ran with CUDA_HOME=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">cuda_home_compile</span><span class="p">,</span>
               <span class="n">cuda_home_runtime</span> <span class="o">?</span> <span class="nl">cuda_home_runtime</span> <span class="p">:</span> <span class="s">&quot;&lt;null&gt;&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This program is pretty basic, but enough to demonstrate the use of environment variables from ReFrame.
It simply compares the value of the <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> macro with the value of the environment variable <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> at runtime, printing <code class="docutils literal"><span class="pre">SUCCESS</span></code> if they are not empty and match.
The Makefile for this example compiles this source by simply setting <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> to the value of the <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> environment variable:</p>
<div class="highlight-makefile"><div class="highlight"><pre><span></span><span class="nv">EXECUTABLE</span> <span class="o">:=</span> advanced_example4

<span class="nv">CPPFLAGS</span> <span class="o">=</span> -DCUDA_HOME<span class="o">=</span><span class="se">\&quot;</span><span class="k">$(</span>CUDA_HOME<span class="k">)</span><span class="se">\&quot;</span>

<span class="nf">.SUFFIXES</span><span class="o">:</span> .<span class="n">o</span> .<span class="n">c</span>

<span class="nv">OBJS</span> <span class="o">:=</span> advanced_example4.o

<span class="nf">$(EXECUTABLE)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OBJS</span><span class="k">)</span>
    <span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> <span class="k">$(</span>LDFLAGS<span class="k">)</span> -o <span class="nv">$@</span> $^

<span class="nf">$(OBJS)</span><span class="o">:</span> <span class="n">advanced_example</span>4.<span class="n">c</span>
    <span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>CPPFLAGS<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> -c <span class="k">$(</span>LDFLAGS<span class="k">)</span> -o <span class="nv">$@</span> $^

<span class="nf">clean</span><span class="o">:</span>
    /bin/rm -f <span class="k">$(</span>OBJS<span class="k">)</span> <span class="k">$(</span>EXECUTABLE<span class="k">)</span>
</pre></div>
</div>
<p>Coming back now to the ReFrame regression test, the <code class="docutils literal"><span class="pre">CUDATOOLKIT_HOME</span></code> environment variable is defined by the <code class="docutils literal"><span class="pre">cudatoolkit</span></code> module.
If you try to run the test, you will see that it will succeed, meaning that the <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> variable was set correctly both during the compilation and the runtime.</p>
<p>When ReFrame <a class="reference external" href="pipeline.html#the-setup-phase">sets up</a> a test, it first loads its required modules and then sets the required environment variables expanding their values.
This has the result that <code class="docutils literal"><span class="pre">CUDA_HOME</span></code> takes the correct value in our example at the compilation time.</p>
<p>At runtime, ReFrame will generate the following instructions in the shell script associated with this test:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>module load cudatoolkit
<span class="nb">export</span> <span class="nv">CUDA_HOME</span><span class="o">=</span><span class="nv">$CUDATOOLKIT_HOME</span>
</pre></div>
</div>
<p>This ensures that the environment of the test is also set correctly at runtime.</p>
<p>Finally, as already mentioned <a class="reference external" href="#leveraging-makefiles">previously</a>, since the <code class="docutils literal"><span class="pre">Makefile</span></code> name is not one of the standard ones, it has to be passed as an argument to the <code class="docutils literal"><span class="pre">compile</span></code> method of the base <code class="docutils literal"><span class="pre">RegressionTest</span></code> class as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">makefile</span><span class="o">=</span><span class="s1">&#39;Makefile_example4&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-a-time-limit-for-regression-tests">
<span id="setting-a-time-limit-for-regression-tests"></span><h2>Setting a Time Limit for Regression Tests<a class="headerlink" href="#setting-a-time-limit-for-regression-tests" title="Permalink to this headline">¶</a></h2>
<p>ReFrame gives you the option to limit the execution time of regression tests.
The following example (<code class="docutils literal"><span class="pre">tutorial/advanced/advanced_example5.py</span></code>) demonstrates how you can achieve this by limiting the execution time of a test that tries to sleep 100 seconds:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">reframe.utility.sanity</span> <span class="kn">as</span> <span class="nn">sn</span>
<span class="kn">from</span> <span class="nn">reframe.core.pipeline</span> <span class="kn">import</span> <span class="n">RunOnlyRegressionTest</span>


<span class="k">class</span> <span class="nc">TimeLimitTest</span><span class="p">(</span><span class="n">RunOnlyRegressionTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;time_limit_check&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ReFrame tutorial demonstrating the use&#39;</span>
                      <span class="s1">&#39;of a user-defined time limit&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;daint:gpu&#39;</span><span class="p">,</span> <span class="s1">&#39;daint:mc&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;sleep&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;100&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;CANCELLED.*DUE TO TIME LIMIT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;put-your-name-here&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tutorial&#39;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">_get_checks</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">TimeLimitTest</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
</pre></div>
</div>
<p>The important bit here is the following line that sets the time limit for the test to one minute:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">time_limit</span></code> attribute is a three-tuple in the form <code class="docutils literal"><span class="pre">(HOURS,</span> <span class="pre">MINUTES,</span> <span class="pre">SECONDS)</span></code>.
Time limits are implemented for both the Slurm and the local scheduler backends.</p>
<p>The sanity condition for this test verifies that associated job has been canceled due to the time limit.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">sanity_patterns</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span><span class="s1">&#39;CANCELLED.*TIME LIMIT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          
<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="deferrables.html" class="btn btn-neutral float-right" title="Understanding the Mechanism of Sanity Functions" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial.html" class="btn btn-neutral" title="ReFrame Tutorial" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, CSCS.
    </p>

    <style type="text/css">
      .cscs_group:after {
        content:"";
        display: table;
        clear: both;
      }
      .cscs_left {
        float: left;
        width: 50%;
      }
      .cscs_right {
        float: right;
        width: 50%;
    }
      @media screen and (max-width: 768px) {
        .cscs_left,
        .cscs_right {
          float: none;
          width: auto;
          margin-bottom: 20px;
        }
      }
    </style>
    <p>
      <div class="cscs_group">
        <div class="cscs_left">
          <strong>CSCS</strong><br />
          <strong>Swiss National Supercomputing Centre</strong><br />
          Via Trevano 131<br />
          6900 Lugano<br />
          Switzerland
        </div>
        <div  class="cscs_right" style="margin-left: auto; margin-right: auto;">
          <a href="http://www.cscs.ch" target="_blank">
            <img id="cscs-cscs-logo" src="_static/img/logo_cscs.png" style="background-color: transparent; margin-top: 5px;">
          </a>
        </div>
      </div>
    </p>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

  </div>

</footer>
        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: master
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../v2.7/advanced.html">v2.7</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="advanced.html">master</a></dd>
        </dl>
    </div>
</div>


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.8',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>